## 三次握手

1. 客户端设置`SYN=1`，生成一个随机值`seq=J`，通知服务端需要建立连接，然后客户端进入`SYN_SENT`的等待状态

```
SYN=1;  seq=J;
```

2. 服务端收到数据包后由`SYN=1`知道客户端请求建立连接，把`SYN`和`ACK`置为 1，根据 seq 生成`ack=J+1`，生成一个随机值`seq=K`，一并再发送给客户端，然后服务端进入`SYN_RCVD`状态

```
SYN=1;  ACK=1;  ack=J+1;  seq=K;
```

3. 客户端收到确认消息后，检查`ack`是否等于 J+1，`ACK`是否为 1，如果正确：把`ACK`置为 1，根据 ack 生成`ack=K+1`，客户端进入`ESTABLISHED`状态

```
ACK=1;  ack=K+1;
```

4. 服务端收到确认消息检查`ack`是否等于 K+1，`ACK`是否为 1，如果正确，服务端进入`ESTABLISHED`状态，三次握手完成，可以互相传输数据

## 四次挥手

1. 客户端设置`FIN=1`，生成一个随机值`seq=J`，通知服务端没有数据要发送了，然后客户端进入`FIN_WAIT_1`的等待状态

```
FIN=1;  seq=J;
```

2. 服务端识别到`FIN=1`，根据 ack 生成`ack=J+1`，发送给客户端，然后进入`CLOSE_WAIT`的等待状态，继续发送未发送完的数据，客户端收到后进入`FIN_WAIT_2`状态

```
ACK=1;  ack=J+1
```

3. 服务端发送完所有数据后，发送`FIN=1`给客户端，说明可以关闭连接，然后进入`LAST_ACK`状态

```
FIN=1;  seq=K;
```

4. 客户端识别到`FIN=1`，根据 ack 生成`ack=K+1`，发送给服务端，然后客户端进入`TIME_WAIT`状态，等待 2MSL 后没有回复则关闭连接，服务端收到后直接关闭连接

```
ACK=1;  ack=K+1;
```
